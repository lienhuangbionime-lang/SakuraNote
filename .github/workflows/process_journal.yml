name: Process Journal Entry

on:
  repository_dispatch:
    types: [new_journal_entry]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  neural_pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout content
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow python-frontmatter google-generativeai requests

      # 1. æ ¸å¿ƒè™•ç† (Gemini åˆ†æ -> ç”Ÿæˆ Inbox æª”æ¡ˆ)
      - name: ğŸ§  Neural Intake (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          JOURNAL_TEXT: ${{ github.event.client_payload.text }}
        run: python src/actions/process_inbox.py

      # 2. è‡ªå‹•åˆ†é¡ (Project/Life åˆ†æµ)
      - name: ğŸ—‚ï¸ Auto-Classification
        run: python src/actions/classify_inbox.py

      # 3. ä»»å‹™åŒæ­¥ (å‚³é€è‡³ Zapier -> Google Tasks)
      - name: âœ… Sync Tasks to Google
        env:
          ZAPIER_TASK_WEBHOOK: ${{ secrets.ZAPIER_TASK_WEBHOOK }}
        run: python src/actions/sync_tasks.py

      # 4. å ±å‘Šç”Ÿæˆ (å¯é¸ï¼Œæ¯æ¬¡è·‘æˆ–è¨­æ’ç¨‹)
      - name: ğŸ“Š Generate Project Status
        run: python src/actions/generate_report.py

      # 5. è³‡æ–™å£“ç¸®èˆ‡æ¸…ç† (Inbox -> Archive)
      - name: ğŸ—œï¸ Compaction & Cleanup
        run: python src/actions/compact_inbox.py

      # 6. æäº¤æ‰€æœ‰è®Šæ›´
      - name: Commit Neural State
        run: |
          git config --global user.name "LifeOS Bot"
          git config --global user.email "bot@lifeos.ai"
          git add data/
          git commit -m "ğŸ§  Neural Process Complete: ${{ github.event.client_payload.metadata.date }}" || echo "No changes to commit"
          git pull --rebase origin main
          git push
